{"version":3,"sources":["sessions/sessions_common.js","sessions/sessions_server.js"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,c;;AAEA,uD;AACA,0B;AACA,qC;AACA,qC;AACA,oC;AACA,G;;AAEA,sB;;AAEA,kD;AACA,sB;AACA,e;AACA,gC;AACA,W;AACA,G;AACA,kB;AACA,e;AACA,2B;AACA,W;AACA,G;AACA,4B;AACA,e;AACA,qC;AACA,W;AACA,G;AACA,a;AACA,e;AACA,8B;AACA,E;AACA,G;;;;;;;;;;;;;;;;;;;;AC/BA,6E;;AAEA,kC;AACA,M;AACA,a;AACA,yB;AACA,4C;AACA,8C;AACA,sC;AACA,oD;AACA,oB;AACA,W;AACA,iB;AACA,I;AACA,G;AACA,G;AACA,U;AACA,e;AACA,+B;AACA,gB;AACA,G;AACA,O;AACA,gB;AACA,gB;AACA,G;AACA,W;AACA,e;AACA,c;AACA,gB;AACA,E;AACA,G;;AAEA,qC;AACA,S;AACA,e;AACA,a;AACA,G;AACA,Y;AACA,e;AACA,c;AACA,gB;AACA,G;AACA,W;AACA,e;AACA,a;AACA,G;AACA,W;AACA,e;AACA,a;AACA,G;AACA,a;AACA,mB;AACA,E;AACA,G;;AAEA,kE;;;AAGA,oC;AACA,M;AACA,a;AACA,yB;AACA,0C;AACA,qB;AACA,oB;AACA,W;AACA,iB;AACA,I;AACA,G;AACA,G;AACA,S;AACA,e;AACA,0B;AACA,G;AACA,U;AACA,e;AACA,gB;AACA,G;AACA,W;AACA,e;AACA,iB;AACA,G;AACA,gB;AACA,e;AACA,8B;AACA,G;AACA,sB;AACA,c;AACA,G;AACA,Y;AACA,e;AACA,gB;AACA,G;AACA,iB;AACA,e;AACA,8B;AACA,G;AACA,mB;AACA,e;AACA,W;AACA,G;AACA,0B;AACA,e;AACA,a;AACA,E;AACA,G;;AAEA,kE;;AAEA,mC;AACA,M;AACA,a;AACA,yB;AACA,0C;AACA,oC;AACA,oB;AACA,I;AACA,G;AACA,G;AACA,S;AACA,e;AACA,yB;AACA,G;AACA,U;AACA,e;AACA,gB;AACA,G;AACA,kB;AACA,e;AACA,gB;AACA,G;AACA,c;AACA,e;AACA,gB;AACA,G;AACA,a;AACA,e;AACA,gB;AACA,G;AACA,iB;AACA,e;AACA,gB;AACA,G;AACA,S;AACA,e;AACA,gB;AACA,G;AACA,iB;AACA,e;AACA,gB;AACA,G;AACA,S;AACA,e;AACA,gB;AACA,G;AACA,Y;AACA,e;AACA,gB;AACA,E;AACA,G;;AAEA,oB;;AAEA,gD;AACA,Y;AACA,e;AACA,qF;AACA,G;AACA,iB;AACA,e;AACA,mB;AACA,G;AACA,a;AACA,e;AACA,qD;AACA,G;AACA,W;AACA,e;AACA,mB;AACA,G;AACA,S;AACA,e;AACA,mB;AACA,E;AACA,G;;AAEA,+B;;AAEA,0C;AACA,kB;AACA,0B;AACA,G;;AAEA,sC;AACA,a;AACA,a;AACA,W;AACA,yB;AACA,uB;AACA,oB;AACA,8B;AACA,sC;AACA,W;AACA,iB;AACA,I;AACA,G;AACA,G;AACA,c;AACA,a;AACA,yB;AACA,wC;AACA,oB;AACA,8B;AACA,sC;AACA,W;AACA,iB;AACA,I;AACA,G;AACA,G;AACA,Y;AACA,c;AACA,G;AACA,iB;AACA,e;AACA,8B;AACA,G;AACA,mB;AACA,e;AACA,U;AACA,G;AACA,0B;AACA,e;AACA,a;AACA,G;AACA,W;AACA,e;AACA,gB;AACA,G;AACA,gB;AACA,e;AACA,+B;AACA,G;AACA,sB;AACA,c;AACA,G;AACA,Q;AACA,e;AACA,4B;AACA,G;AACA,S;AACA,e;AACA,uD;AACA,G;AACA,Q;AACA,e;AACA,gB;AACA,G;AACA,a;AACA,a;AACA,yB;AACA,qD;AACA,mB;AACA,oB;AACA,W;AACA,iB;AACA,I;AACA,G;AACA,G;AACA,uB;AACA,oB;AACA,G;AACA,Q;AACA,e;AACA,gB;AACA,G;AACA,qB;AACA,a;AACA,gB;AACA,G;AACA,gB;AACA,e;AACA,0B;AACA,G;AACA,kB;AACA,qB;AACA,G;AACA,U;AACA,e;AACA,gB;AACA,G;AACA,e;AACA,a;AACA,yB;AACA,8C;AACA,wC;AACA,qC;AACA,oB;AACA,W;AACA,iB;AACA,I;AACA,G;AACA,G;AACA,oB;AACA,gB;AACA,iB;AACA,yB;AACA,wC;AACA,oB;AACA,iB;AACA,I;AACA,G;AACA,G;AACA,iB;AACA,oC;AACA,iB;AACA,sB;AACA,8C;AACA,uC;AACA,sB;AACA,I;AACA,G;AACA,G;AACA,Y;AACA,e;AACA,gB;AACA,G;AACA,iB;AACA,a;AACA,yB;AACA,kD;AACA,yB;AACA,oB;AACA,W;AACA,iB;AACA,I;AACA,G;AACA,G;AACA,wB;AACA,e;AACA,oD;AACA,G;AACA,O;AACA,e;AACA,gB;AACA,G;AACA,e;AACA,e;AACA,W;AACA,yB;AACA,G;AACA,iB;AACA,oB;AACA,G;AACA,gB;AACA,e;AACA,gB;AACA,G;AACA,qB;AACA,a;AACA,yB;AACA,qD;AACA,mB;AACA,oB;AACA,W;AACA,iB;AACA,I;AACA,G;AACA,G;AACA,+B;AACA,oB;AACA,E;AACA,G;;AAEA,oD;;AAEA,wC;AACA,kB;AACA,sC;AACA,G;;AAEA,gB;AACA,gC;AACA,iB;AACA,mC;AACA,mB;AACA,M;AACA,Y;AACA,e;AACA,I;AACA,K;AACA,qD;AACA,+B;AACA,G;AACA,O;AACA,6B;AACA,e;AACA,+B;AACA,G;;AAEA,4C;AACA,kB;AACA,0B;AACA,iB;AACA,2B;AACA,M;AACA,U;AACA,2B;AACA,K;AACA,W;AACA,uC;AACA,I;AACA,K;;AAEA,iB;AACA,+B;AACA,G;AACA,G;AACA,2B;AACA,4D;AACA,+B;AACA,G;AACA,a;AACA,O;AACA,+D;AACA,e;AACA,+B;AACA,G;AACA,gB;AACA,G;AACA,iC;AACA,mC;AACA,mB;AACA,M;AACA,Y;AACA,mB;AACA,e;AACA,I;AACA,K;AACA,qD;AACA,+B;AACA,G;AACA,O;AACA,0B;AACA,e;AACA,+B;AACA,G;AACA,4C;AACA,qB;AACA,mD;AACA,W;AACA,kB;AACA,2B;AACA,c;AACA,K;AACA,U;AACA,wB;AACA,K;AACA,Y;AACA,W;AACA,8B;AACA,e;AACA,mB;AACA,6B;AACA,M;AACA,M;AACA,Y;AACA,2B;AACA,sB;AACA,mB;AACA,wB;AACA,gB;AACA,oB;AACA,8B;AACA,O;AACA,M;AACA,K;AACA,K;AACA,Y;AACA,a;AACA,I;AACA,K;;AAEA,iB;AACA,+B;AACA,G;AACA,qB;AACA,G;AACA,sC;AACA,iB;AACA,mC;AACA,mB;AACA,M;AACA,Y;AACA,yB;AACA,e;AACA,I;AACA,K;AACA,qD;AACA,+B;AACA,G;AACA,O;AACA,8C;AACA,+C;AACA,e;AACA,+B;AACA,G;;AAEA,6C;AACA,wB;AACA,0B;AACA,iB;AACA,2B;AACA,M;AACA,Y;AACA,c;AACA,uB;AACA,gB;AACA,sB;AACA,I;AACA,K;;AAEA,iB;AACA,+B;AACA,G;;AAEA,a;AACA,O;AACA,+D;AACA,e;AACA,+B;AACA,G;;AAEA,6C;AACA,sB;AACA,6C;AACA,yB;AACA,0B;AACA,iB;AACA,I;;AAEA,qD;AACA,U;AACA,oD;AACA,wD;AACA,wD;AACA,wB;AACA,K;AACA,W;AACA,qC;AACA,I;AACA,K;;AAEA,sB;AACA,+B;AACA,G;;AAEA,c;AACA,E;AACA,G;;AAEA,qC;AACA,a;AACA,e;AACA,yB;AACA,iB;AACA,yB;AACA,8C;AACA,gD;AACA,+B;AACA,c;AACA,I;AACA,G;AACA,G;AACA,mB;AACA,e;AACA,yB;AACA,gB;AACA,G;AACA,sB;AACA,e;AACA,yB;AACA,gB;AACA,E;AACA,G;;AAEA,uC;AACA,iB;AACA,e;AACA,+B;AACA,gB;AACA,G;AACA,gB;AACA,e;AACA,+B;AACA,gB;AACA,G;AACA,S;AACA,a;AACA,gB;AACA,G;AACA,O;AACA,a;AACA,gB;AACA,E;AACA,G;;AAEA,iD;AACA,iB;AACA,e;AACA,+B;AACA,gB;AACA,G;AACA,S;AACA,Y;AACA,G;AACA,O;AACA,Y;AACA,E;AACA,G;;AAEA,0D;AACA,iB;AACA,sD;AACA,Y;AACA,E;AACA,M;AACA,+B;AACA,2B;AACA,gC;AACA,4B;AACA,uC;AACA,c;AACA,Y;AACA,E;AACA,qB;AACA,kC;AACA,wB;AACA,yD;AACA,qD;AACA,sB;AACA,oB;AACA,E;AACA,2C;AACA,2C;AACA,wB;AACA,E;AACA,6C;AACA,6C;AACA,yB;AACA,E;AACA,6I;AACA,gD;AACA,W;AACA,mB;AACA,yB;AACA,4B;AACA,e;AACA,6B;AACA,I;AACA,a;AACA,c;AACA,oB;AACA,+B;AACA,sD;AACA,6C;AACA,2B;AACA,sC;AACA,sC;AACA,I;AACA,iC;AACA,sD;AACA,6C;AACA,2B;AACA,6B;AACA,gC;AACA,I;AACA,wC;AACA,I;AACA,yB;AACA,gC;AACA,G;AACA,I;;AAEA,c;AACA,yB;AACA,6B;AACA,gB;AACA,I;AACA,G;;AAEA,wD;AACA,iB;AACA,sD;AACA,Y;AACA,E;AACA,yB;AACA,M;AACA,yC;AACA,0C;AACA,c;AACA,Y;AACA,E;AACA,qB;AACA,qB;AACA,kB;AACA,G;AACA,qB;AACA,mB;AACA,6C;AACA,6C;AACA,yB;AACA,E;AACA,c;AACA,iB;AACA,0D;AACA,sB;AACA,4B;AACA,qB;AACA,gC;AACA,gC;AACA,Y;AACA,gG;AACA,sD;AACA,qC;AACA,W;AACA,wB;AACA,I;AACA,uB;AACA,0B;AACA,oB;AACA,qB;AACA,kE;AACA,I;AACA,kC;AACA,sD;AACA,yB;AACA,4B;AACA,2B;AACA,qC;AACA,wB;AACA,2B;AACA,sB;AACA,mE;AACA,I;AACA,I;AACA,0B;AACA,wB;AACA,2B;AACA,0B;AACA,iE;AACA,G;AACA,I;;AAEA,yC;AACA,6D;AACA,I;AACA,sB;AACA,c;;AAEA,yB;AACA,0C;AACA,4D;AACA,K;AACA,gB;AACA,I;AACA,G;;AAEA,kD;AACA,iB;AACA,2D;AACA,Y;AACA,E;AACA,wF;AACA,gB;AACA,yB;AACA,Y;AACA,mD;AACA,wF;AACA,gB;AACA,yB;AACA,Y;AACA,mD;AACA,4J;AACA,yB;AACA,6B;AACA,6B;AACA,6B;AACA,I;AACA,c;AACA,G;;AAEA,+C;AACA,iB;AACA,sD;AACA,W;AACA,kB;AACA,wB;AACA,c;AACA,G;AACA,G;AACA,I;AACA,+C;AACA,Y;AACA,E;AACA,M;AACA,6B;AACA,c;AACA,Y;AACA,E;;AAEA,sC;AACA,yC;AACA,G;AACA,G;AACA,uD;AACA,0C;AACA,+C;AACA,mD;AACA,G;AACA,0D;AACA,wD;AACA,4D;AACA,G;AACA,yC;AACA,mB;AACA,2B;AACA,iC;AACA,I;AACA,oB;AACA,mC;AACA,yC;AACA,I;AACA,U;AACA,Q;AACA,uB;AACA,kE;AACA,gG;AACA,oC;AACA,oC;AACA,oC;AACA,8B;AACA,4C;AACA,sC;AACA,e;AACA,c;AACA,uC;AACA,4B;AACA,6C;AACA,S;AACA,+C;AACA,4B;AACA,6C;AACA,Q;AACA,O;AACA,O;AACA,yE;AACA,iB;AACA,2B;AACA,gF;AACA,6B;AACA,6B;AACA,uB;AACA,e;AACA,c;AACA,uC;AACA,2B;AACA,Q;AACA,O;AACA,O;AACA,4B;AACA,kF;AACA,6B;AACA,qC;AACA,+B;AACA,e;AACA,c;AACA,+C;AACA,2B;AACA,Q;AACA,O;AACA,O;AACA,K;AACA,0D;AACA,gB;AACA,8B;AACA,I;AACA,G;AACA,a;AACA,G;;AAEA,0D;AACA,W;AACA,iC;AACA,wC;AACA,gD;AACA,sB;AACA,G;AACA,oB;AACA,gC;AACA,uD;AACA,I;AACA,kC;AACA,yD;AACA,I;AACA,0B;AACA,+B;AACA,G;AACA,I;AACA,c;AACA,0B;AACA,gB;AACA,I;AACA,G;;AAEA,oD;AACA,0B;AACA,iB;;AAEA,sD;AACA,W;AACA,wB;AACA,c;AACA,G;AACA,I;AACA,oD;AACA,Y;AACA,E;AACA,M;AACA,4B;AACA,c;AACA,Y;AACA,E;;AAEA,sC;AACA,a;AACA,O;AACA,kH;AACA,2B;AACA,2B;AACA,qB;;AAEA,kH;AACA,oB;AACA,gB;AACA,O;AACA,Y;AACA,qC;AACA,sB;AACA,M;AACA,K;AACA,M;AACA,e;AACA,G;AACA,G;AACA,a;AACA,G;;AAEA,wC;AACA,iB;AACA,4B;AACA,e;AACA,K;AACA,W;AACA,c;AACA,gC;AACA,mC;AACA,oC;AACA,G;AACA,oB;AACA,gC;AACA,uD;AACA,I;AACA,kC;AACA,yD;AACA,I;AACA,0B;AACA,gC;AACA,G;AACA,I;AACA,c;;AAEA,0B;AACA,gB;AACA,I;AACA,G;;AAEA,gB;AACA,0B;AACA,6B;AACA,qC;AACA,G;AACA,kB;AACA,sB;AACA,qC;AACA,8B;AACA,4B;AACA,6B;AACA,M;AACA,U;AACA,sB;AACA,mC;AACA,I;AACA,M;AACA,c;AACA,K;AACA,E;AACA,G;;AAEA,gB;AACA,0B;AACA,6B;AACA,qC;AACA,G;AACA,kB;AACA,wC;AACA,iC;AACA,2B;AACA,qF;AACA,gC;AACA,2B;AACA,Q;AACA,Y;AACA,wB;AACA,O;AACA,a;AACA,sB;AACA,oB;AACA,mC;AACA,iC;AACA,yC;AACA,yB;AACA,yB;AACA,+B;AACA,wC;AACA,O;AACA,M;AACA,O;AACA,I;AACA,K;AACA,E;AACA,G;;AAEA,4B;AACA,qC;AACA,yC;AACA,U;AACA,yB;AACA,K;AACA,W;AACA,oB;AACA,uB;AACA,qB;AACA,K;AACA,I;AACA,K;AACA,G;;AAEA,mB;AACA,c;AACA,O;AACA,U;AACA,2C;AACA,kB;AACA,mC;AACA,oB;AACA,0B;AACA,uB;AACA,6B;AACA,4B;AACA,kB;AACA,iC;AACA,e;AACA,iB;AACA,4B;AACA,0B;AACA,qB;AACA,M;AACA,kB;AACA,2C;AACA,wC;AACA,0C;AACA,kE;AACA,8D;AACA,uC;AACA,2C;AACA,+C;AACA,qD;AACA,4D;AACA,kD;AACA,oD;AACA,sD;AACA,4E;AACA,0C;AACA,8B;AACA,wC;AACA,wC;AACA,8C;AACA,0C;AACA,iB;AACA,M;AACA,sB;AACA,wC;AACA,4B;AACA,oC;AACA,oC;AACA,c;AACA,a;AACA,0C;AACA,M;AACA,mB;AACA,6B;AACA,2C;AACA,0C;AACA,iD;AACA,K;AACA,K;AACA,a;AACA,yC;AACA,kM;AACA,wB;AACA,6F;AACA,6F;AACA,2E;AACA,uD;AACA,6D;AACA,mE;AACA,uE;AACA,+D;AACA,yE;AACA,qD;AACA,mM;AACA,+H;AACA,6D;AACA,8C;AACA,wC;AACA,sE;AACA,mY;AACA,K;AACA,a;AACA,qE;AACA,uB;AACA,ma;AACA,mC;AACA,0B;AACA,wC;AACA,sE;AACA,kS;AACA,6B;AACA,6K;AACA,6D;AACA,wD;AACA,0B;AACA,0L;AACA,oH;AACA,+H;AACA,+J;AACA,4D;AACA,6R;AACA,0M;AACA,6M;AACA,0N;AACA,4M;AACA,6J;AACA,8J;AACA,qD;AACA,sT;AACA,wH;AACA,I;AACA,I;AACA,O;AACA,U;AACA,6D;AACA,kB;AACA,4C;AACA,sB;AACA,4B;AACA,mC;AACA,mC;AACA,kC;AACA,qB;AACA,iC;AACA,iB;AACA,gB;AACA,gC;AACA,0B;AACA,+B;AACA,M;AACA,kB;AACA,+C;AACA,yC;AACA,mD;AACA,2E;AACA,oE;AACA,uC;AACA,2C;AACA,gE;AACA,qD;AACA,qE;AACA,iE;AACA,qD;AACA,2D;AACA,sE;AACA,2C;AACA,8B;AACA,yC;AACA,wC;AACA,8C;AACA,wC;AACA,iB;AACA,M;AACA,sB;AACA,qC;AACA,6B;AACA,sC;AACA,sC;AACA,a;AACA,a;AACA,8C;AACA,M;AACA,mB;AACA,8B;AACA,2C;AACA,0C;AACA,4C;AACA,K;AACA,K;AACA,a;AACA,wC;AACA,+L;AACA,wB;AACA,gG;AACA,gG;AACA,2F;AACA,uD;AACA,kE;AACA,8C;AACA,+C;AACA,wE;AACA,4E;AACA,kE;AACA,sM;AACA,qJ;AACA,yE;AACA,gD;AACA,4C;AACA,8D;AACA,uZ;AACA,K;AACA,a;AACA,4E;AACA,uB;AACA,qd;AACA,yC;AACA,4B;AACA,iC;AACA,sF;AACA,oR;AACA,sB;AACA,mM;AACA,gD;AACA,yD;AACA,mB;AACA,oL;AACA,yH;AACA,iI;AACA,2L;AACA,sD;AACA,yR;AACA,6N;AACA,qL;AACA,mM;AACA,4L;AACA,mL;AACA,qJ;AACA,kE;AACA,uR;AACA,wH;AACA,I;AACA,G;AACA,G;;AAEA,oD;AACA,+B;AACA,mB;AACA,8C;AACA,mB;AACA,sE;AACA,sC;AACA,oD;AACA,mC;AACA,gF;AACA,mE;AACA,qC;AACA,oC;AACA,gC;AACA,mD;AACA,+E;AACA,qH;AACA,uF;AACA,uF;AACA,qF;AACA,iD;AACA,8D;AACA,8E;AACA,iB;;AAEA,sC;AACA,oD;AACA,+B;AACA,sD;AACA,6B;AACA,6C;AACA,+C;AACA,sB;AACA,S;AACA,2C;AACA,0C;AACA,8H;AACA,kD;AACA,2B;AACA,mD;AACA,gE;AACA,6C;AACA,+C;AACA,sB;AACA,S;AACA,4E;AACA,2C;AACA,yC;AACA,iB;;AAEA,8C;AACA,wD;AACA,mD;AACA,2D;AACA,4E;AACA,2D;AACA,iB;;AAEA,wC;AACA,qD;AACA,qC;AACA,qD;AACA,yC;AACA,iD;AACA,uC;AACA,2D;AACA,G;;AAEA,wC;AACA,kC;AACA,mB;AACA,6C;AACA,mB;AACA,mD;AACA,iB;;AAEA,+C;AACA,qB;AACA,qB;AACA,qB;AACA,qB;AACA,oD;AACA,oD;AACA,oD;AACA,oD;AACA,oD;AACA,oD;AACA,iB;;AAEA,qB;AACA,qB;AACA,4B;AACA,0B;AACA,wB;AACA,iB;;AAEA,mB;AACA,uD;AACA,mB;AACA,qB;AACA,G;;AAEA,wC;AACA,kC;AACA,mB;AACA,6C;AACA,iB;;AAEA,mB;AACA,0C;AACA,qB;AACA,kD;AACA,kD;AACA,kD;AACA,kD;AACA,qB;AACA,iB;;AAEA,0C;AACA,kD;AACA,kD;AACA,kD;AACA,iB;;AAEA,0C;AACA,kD;AACA,kD;AACA,kD;AACA,kD;AACA,iB;;AAEA,0C;AACA,8C;AACA,8C;AACA,8C;AACA,8C;AACA,8C;AACA,8C;AACA,8C;AACA,iB;;AAEA,mB;AACA,0C;AACA,mB;AACA,qB;AACA,qB;AACA,G;;AAEA,iE;AACA,6B;AACA,8B;;AAEA,iC;AACA,gD;AACA,K;;AAEA,iC;AACA,uB;AACA,K;;AAEA,4B;AACA,0B;AACA,K;;AAEA,2C;AACA,gB;AACA,yB;AACA,gB;AACA,yB;AACA,gB;AACA,2C;AACA,gB;AACA,yB;AACA,gB;AACA,yB;AACA,Y;AACA,G;AACA,iE;AACA,4C;AACA,uD;AACA,sC;AACA,sF;AACA,yE;AACA,wC;AACA,4B;AACA,uB;AACA,oD;AACA,mF;AACA,4H;AACA,sF;AACA,4F;AACA,mF;AACA,gE;AACA,0B;AACA,kH;AACA,2C;AACA,iB;AACA,+D;AACA,e;AACA,wC;AACA,gE;AACA,4D;AACA,qC;AACA,yC;AACA,6C;AACA,mD;AACA,0D;AACA,gD;AACA,kD;AACA,oD;AACA,0E;AACA,I;AACA,+B;AACA,yD;AACA,6B;AACA,uC;AACA,yC;AACA,sB;AACA,S;AACA,iC;AACA,0C;AACA,6H;AACA,kD;AACA,W;AACA,sC;AACA,sC;AACA,4C;AACA,uC;AACA,I;AACA,2B;AACA,qD;AACA,gE;AACA,uC;AACA,yC;AACA,sB;AACA,S;AACA,kF;AACA,iC;AACA,iC;AACA,iB;AACA,4D;AACA,kD;AACA,0D;AACA,iE;AACA,4C;AACA,iE;AACA,iB;AACA,iD;AACA,oC;AACA,wC;AACA,+B;AACA,oC;AACA,yC;AACA,8C;AACA,Y;AACA,G;AACA,G;AACA,uD;;AAEA,wC;AACA,sB;AACA,K;AACA,Y;AACA,mB;AACA,gC;AACA,mD;AACA,Y;AACA,a;AACA,M;AACA,a;AACA,Y;AACA,2B;AACA,O;AACA,a;AACA,sD;AACA,M;AACA,M;AACA,a;AACA,yB;AACA,gB;AACA,qC;AACA,uC;AACA,6C;AACA,8C;AACA,K;AACA,M;;AAEA,uB;AACA,sB;AACA,gC;AACA,W;AACA,0C;AACA,0C;AACA,W;AACA,W;AACA,4C;AACA,iD;AACA,Y;AACA,K;AACA,0C;AACA,+C;AACA,Y;AACA,K;AACA,I;AACA,8B;AACA,iC;AACA,W;AACA,kD;AACA,2C;AACA,W;AACA,W;AACA,oD;AACA,kD;AACA,Y;AACA,K;AACA,kD;AACA,gD;AACA,Y;AACA,K;AACA,I;AACA,+C;AACA,wD;;AAEA,6F;AACA,0C;AACA,Y;AACA,qC;AACA,gB;AACA,4B;AACA,O;AACA,6C;AACA,gB;AACA,4B;AACA,M;AACA,K;AACA,M;;AAEA,uE;;AAEA,4H;AACA,4E;AACA,+B;AACA,Y;AACA,yB;AACA,O;AACA,W;AACA,wB;AACA,M;AACA,Y;AACA,6E;AACA,K;AACA,M;AACA,G;AACA,I;AACA,G","file":"/packages/sessions.js","sourcesContent":["Sessions = {};\n\nSessions.collection = new Mongo.Collection('sessions');\nSessions.collection.deny({\n\tinsert: function() { return true; },\n\tupdate: function() { return true; },\n\tremove: function() { return true; }\n});\n\nSessions.schemas = {};\n\nSessions.schemas.dentistNotes = new SimpleSchema({\n\tclinicalImpression: {\n\t\ttype: String,\n\t\tlabel: 'Clinical Impressions',\n\t\tmax: 5000\n\t},\n\trecommendation: {\n\t\ttype: String,\n\t\tlabel: 'Recommendations',\n\t\tmax: 5000\n\t},\n\trecommendedPrescriptions: {\n\t\ttype: String,\n\t\tlabel: 'Recommended Prescriptions',\n\t\tmax: 5000\n\t},\n\tsessionId: {\n\t\ttype: String,\n\t\tregEx: SimpleSchema.RegEx.Id\n\t}\n});\n\n","var UUID = /^[0-9A-F]{8}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{12}$/i;\n\nvar accessLog = new SimpleSchema({\n\tat: {\n\t\ttype: Date,\n\t\tautoValue: function() {\n\t\t\tvar userId = this.siblingField('userId');\n\t\t\tvar transId = this.siblingField('transId');\n\t\t\tvar fax = this.siblingField('fax');\n\t\t\tif (userId.isSet || transId.isSet || fax.isSet) {\n\t\t\t\treturn new Date;\n\t\t\t} else {\n\t\t\t\tthis.unset();\n\t\t\t}\n\t\t}\n\t},\n\tuserId: {\n\t\ttype: String,\n\t\tregEx: SimpleSchema.RegEx.Id,\n\t\toptional: true\n\t},\n\tfax: {\n\t\ttype: Boolean,\n\t\toptional: true\n\t},\n\ttransId: {\n\t\ttype: String,\n\t\tregEx: UUID,\n\t\toptional: true\n\t}\n});\n\nvar trueVaultRef = new SimpleSchema({\n\tdocId: {\n\t\ttype: String,\n\t\tregEx: UUID\n\t},\n\tschemaId: {\n\t\ttype: String,\n\t\tregEx: UUID,\n\t\toptional: true\n\t},\n\tvaultId: {\n\t\ttype: String,\n\t\tregEx: UUID\n\t},\n\ttransId: {\n\t\ttype: String,\n\t\tregEx: UUID\n\t},\n\taccessLog: {\n\t\ttype: [accessLog]\n\t}\n});\n\nvar voipState = ['ready', 'queued', 'assigned', 'failed', 'done'];\n\n\nvar voipHistory = new SimpleSchema({\n\tat: {\n\t\ttype: Date,\n\t\tautoValue: function() {\n\t\t\tvar state = this.siblingField('state');\n\t\t\tif (state.isSet) {\n\t\t\t\treturn new Date;\n\t\t\t} else {\n\t\t\t\tthis.unset();\n\t\t\t}\n\t\t}\n\t},\n\tstate: {\n\t\ttype: String,\n\t\tallowedValues: voipState\n\t},\n\treason: {\n\t\ttype: String,\n\t\toptional: true\n\t},\n\tdentist: {\n\t\ttype: Object,\n\t\toptional: true,\n\t},\n\t'dentist.id': {\n\t\ttype: String,\n\t\tregEx: SimpleSchema.RegEx.Id\n\t},\n\t'dentist.username': {\n\t\ttype: String\n\t},\n\tlocation: {\n\t\ttype: Object,\n\t\toptional: true\n\t},\n\t'location.id': {\n\t\ttype: String,\n\t\tregEx: SimpleSchema.RegEx.Id\n\t},\n\t'location.name': {\n\t\ttype: String,\n\t\tmax: 100,\n\t},\n\t'location.kioskHandle': {\n\t\ttype: String,\n\t\tregEx: UUID\n\t}\n});\n\nvar faxState = ['ready', 'locked', 'failed', 'sent', 'delivered'];\n\nvar faxHistory = new SimpleSchema({\n\tat: {\n\t\ttype: Date,\n\t\tautoValue: function() {\n\t\t\tvar state = this.siblingField('state');\n\t\t\tif (state.isSet && !this.isSet) {\n\t\t\t\treturn new Date;\n\t\t\t}\n\t\t}\n\t},\n\tstate: {\n\t\ttype: String,\n\t\tallowedValues: faxState\n\t},\n\treason: {\n\t\ttype: String,\n\t\toptional: true\n\t},\n\tSendFaxQueueId: {\n\t\ttype: String,\n\t\toptional: true\n\t},\n\tresultCode: {\n\t\ttype: Number,\n\t\toptional: true\n\t},\n\terrorCode: {\n\t\ttype: Number,\n\t\toptional: true\n\t},\n\tresultMessage: {\n\t\ttype: String,\n\t\toptional: true\n\t},\n\tfaxId: {\n\t\ttype: String,\n\t\toptional: true\n\t},\n\toutboundFaxId: {\n\t\ttype: String,\n\t\toptional: true\n\t},\n\tpages: {\n\t\ttype: Number,\n\t\toptional: true\n\t},\n\tattempts: {\n\t\ttype: Number,\n\t\toptional: true\n\t}\n});\n\nvar tf = ['T', 'F'];\n\nSessions.schemas.surveyForm = new SimpleSchema({\n\twaitTime: {\n\t\ttype: String,\n\t\tallowedValues: ['FIVE_MINUTES', 'TEN_MINUTES', 'FIFTEEN_MINUTES', 'TWENTY_MINUTES']\n\t},\n\tunderstanding: {\n\t\ttype: String,\n\t\tallowedValues: tf\n\t},\n\ttreatment: {\n\t\ttype: String,\n\t\tallowedValues: ['THREE_DAYS', 'FIVE_DAYS', 'NEVER']\n\t},\n\tpleased: {\n\t\ttype: String,\n\t\tallowedValues: tf\n\t},\n\trefer: {\n\t\ttype: String,\n\t\tallowedValues: tf\n\t}\n});\n\nvar langOptions = ['en', 'es'];\n\nvar validLang = Match.Where(function (x) {\n\tcheck(x, String);\n\treturn /^en|es$/.test(x);\n});\n\nSessions.schemaDB = new SimpleSchema({\n\tcreatedAt: {\n\t\ttype: Date,\n\t\tindex: 1,\n\t\tautoValue: function() {\n\t\t\tif (this.isInsert) {\n\t\t\t\treturn new Date;\n\t\t\t} else if (this.isUpsert) {\n\t\t\t\treturn { $setOnInsert: new Date };\n\t\t\t} else {\n\t\t\t\tthis.unset();\n\t\t\t}\n\t\t}\n\t},\n\tmodifiedAt: {\n\t\ttype: Date,\n\t\tautoValue: function() {\n\t\t\tif (this.isInsert || this.isUpdate) {\n\t\t\t\treturn new Date;\n\t\t\t} else if (this.isUpsert) {\n\t\t\t\treturn { $setOnInsert: new Date };\n\t\t\t} else {\n\t\t\t\tthis.unset();\n\t\t\t}\n\t\t}\n\t},\n\tlocation: {\n\t\ttype: Object\n\t},\n\t'location.id': {\n\t\ttype: String,\n\t\tregEx: SimpleSchema.RegEx.Id\n\t},\n\t'location.name': {\n\t\ttype: String,\n\t\tmax: 100\n\t},\n\t'location.kioskHandle': {\n\t\ttype: String,\n\t\tregEx: UUID\n\t},\n\tdentist: {\n\t\ttype: Object,\n\t\toptional: true\n\t},\n\t'dentist.id': {\n\t\ttype: String,\n\t\tregEx: SimpleSchema.RegEx.Id,\n\t},\n\t'dentist.username': {\n\t\ttype: String\n\t},\n\tlang: {\n\t\ttype: String,\n\t\tallowedValues: langOptions\n\t},\n\tstate: {\n\t\ttype: String,\n\t\tallowedValues: ['form', 'voip', 'survey', 'complete']\n\t},\n\tform: {\n\t\ttype: Object,\n\t\toptional: true\n\t},\n\t'form.at': {\n\t\ttype: Date,\n\t\tautoValue: function() {\n\t\t\tvar ref = this.siblingField('trueVaultRef.docId');\n\t\t\tif (ref.isSet) {\n\t\t\t\treturn new Date;\n\t\t\t} else {\n\t\t\t\tthis.unset();\n\t\t\t}\n\t\t}\n\t},\n\t'form.trueVaultRef': {\n\t\ttype: trueVaultRef\n\t},\n\tvoip: {\n\t\ttype: Object,\n\t\toptional: true\n\t},\n\t'voip.enqueuedAt': {\n\t\ttype: Date,\n\t\toptional: true\n\t},\n\t'voip.state': {\n\t\ttype: String,\n\t\tallowedValues: voipState\n\t},\n\t'voip.history': {\n\t\ttype: [voipHistory]\n\t},\n\tsurvey: {\n\t\ttype: Object,\n\t\toptional: true\n\t},\n\t'survey.at': {\n\t\ttype: Date,\n\t\tautoValue: function() {\n\t\t\tvar skipped = this.siblingField('skipped');\n\t\t\tvar form = this.siblingField('form');\n\t\t\tif (skipped.isSet || form.isSet) {\n\t\t\t\treturn new Date;\n\t\t\t} else {\n\t\t\t\tthis.unset();\n\t\t\t}\n\t\t}\n\t},\n\t'survey.skipped': {\n\t\ttype: Boolean,\n\t\toptional: true,\n\t\tautoValue: function() {\n\t\t\tvar form = this.siblingField('form');\n\t\t\tif (form.isSet) {\n\t\t\t\tthis.unset();\n\t\t\t}\n\t\t}\n\t},\n\t'survey.form': {\n\t\ttype: Sessions.schemas.surveyForm,\n\t\toptional: true,\n\t\tcustom: function() {\n\t\t\tvar skipped = this.siblingField('skipped');\n\t\t\tif (!skipped.isSet && !this.isSet) {\n\t\t\t\treturn 'required';\n\t\t\t}\n\t\t}\n\t},\n\tcomplete: {\n\t\ttype: Object,\n\t\toptional: true\n\t},\n\t'complete.at': {\n\t\ttype: Date,\n\t\tautoValue: function() {\n\t\t\tvar condition = this.siblingField('condition');\n\t\t\tif (condition.isSet) {\n\t\t\t\treturn new Date;\n\t\t\t} else {\n\t\t\t\tthis.unset();\n\t\t\t}\n\t\t}\n\t},\n\t'complete.condition': {\n\t\ttype: String,\n\t\tallowedValues: ['timeout', 'inactive', 'finished']\n\t},\n\tfax: {\n\t\ttype: Object,\n\t\toptional: true\n\t},\n\t'fax.state': {\n\t\ttype: String,\n\t\tindex: 1,\n\t\tallowedValues: faxState\n\t},\n\t'fax.history': {\n\t\ttype: [faxHistory]\n\t},\n\tdentistNotes: {\n\t\ttype: Object,\n\t\toptional: true\n\t},\n\t'dentistNotes.at': {\n\t\ttype: Date,\n\t\tautoValue: function() {\n\t\t\tvar ref = this.siblingField('trueVaultRef.docId');\n\t\t\tif (ref.isSet) {\n\t\t\t\treturn new Date;\n\t\t\t} else {\n\t\t\t\tthis.unset();\n\t\t\t}\n\t\t}\n\t},\n\t'dentistNotes.trueVaultRef': {\n\t\ttype: trueVaultRef\n\t}\n});\n\nSessions.collection.attachSchema(Sessions.schemaDB);\n\nvar validId = Match.Where(function (x) {\n\tcheck(x, String);\n\treturn SimpleSchema.RegEx.Id.test(x);\n});\n\nMeteor.methods({\n\tvoipFail: function(sessionId) {\n\t\tthis.unblock();\n\t\tvar user = Meteor.users.findOne({\n\t\t\t_id: this.userId\n\t\t}, {\n\t\t\tfields: {\n\t\t\t\troles: true\n\t\t\t}\n\t\t});\n\t\tif (!Roles.userIsInRole(user, ['dentist', 'ma'])) {\n\t\t\tthrow new Metoer.Error(403);\n\t\t}\n\t\ttry {\n\t\t\tcheck(sessionId, validId);\n\t\t} catch (e) {\n\t\t\tthrow new Meteor.Error(403);\n\t\t}\n\n\t\tvar session = Sessions.collection.update({\n\t\t\t_id: sessionId,\n\t\t\t'dentist.id': user._id,\n\t\t\tstate: 'voip',\n\t\t\t'voip.state': 'assigned'\n\t\t}, {\n\t\t\t$set: {\n\t\t\t\t'voip.state': 'failed',\n\t\t\t},\n\t\t\t$push: {\n\t\t\t\t'voip.history': { state: 'failed' }\n\t\t\t}\n\t\t});\n\n\t\tif (!session) {\n\t\t\tthrow new Meteor.Error(404);\n\t\t}\n\t},\n\tgetVoipToken: function() {\n\t\tif (!Roles.userIsInRole(this.userId, ['dentist', 'ma'])) {\n\t\t\tthrow new Meteor.Error(403);\n\t\t}\n\t\tvar result;\n\t\ttry {\n\t\t\tresult = SightCall.auth(this.userId, 'standard').data.token;\n\t\t} catch (e) {\n\t\t\tthrow new Meteor.Error(500);\n\t\t}\n\t\treturn result;\n\t},\n\tgetNextPatient: function(lang) {\n\t\tvar user = Meteor.users.findOne({\n\t\t\t_id: this.userId\n\t\t}, {\n\t\t\tfields: {\n\t\t\t\tusername: true,\n\t\t\t\troles: true\n\t\t\t}\n\t\t});\n\t\tif (!Roles.userIsInRole(user, ['dentist', 'ma'])) {\n\t\t\tthrow new Meteor.Error(403);\n\t\t}\n\t\ttry {\n\t\t\tcheck(lang, validLang);\n\t\t} catch (e) {\n\t\t\tthrow new Meteor.Error(403);\n\t\t}\n\t\t// This doesn't get checked by collection2\n\t\t// so be careful...\n\t\tvar session = Sessions.collection.findAndModify({\n\t\t\tquery: {\n\t\t\t\tstate: 'voip',\n\t\t\t\t'voip.state': 'queued',\n\t\t\t\tlang: lang\n\t\t\t},\n\t\t\tsort: {\n\t\t\t\t'voip.enqueuedAt': 1\n\t\t\t},\n\t\t\tupdate: {\n\t\t\t\t$set: {\n\t\t\t\t\t'voip.state': 'assigned',\n\t\t\t\t\tdentist: {\n\t\t\t\t\t\tid: user._id,\n\t\t\t\t\t\tusername: user.username\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\t$push: {\n\t\t\t\t\t// Manually include at\n\t\t\t\t\t'voip.history': {\n\t\t\t\t\t\tat: new Date,\n\t\t\t\t\t\tstate: 'assigned',\n\t\t\t\t\t\tdentist: {\n\t\t\t\t\t\t\tid: user._id,\n\t\t\t\t\t\t\tusername: user.username\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t},\n\t\t\tfields: {\n\t\t\t\t_id: true\n\t\t\t}\n\t\t});\n\n\t\tif (!session) {\n\t\t\tthrow new Meteor.Error(404);\n\t\t}\n\t\treturn session._id;\n\t},\n\tcreateDentistNotes: function(notes) {\n\t\tthis.unblock();\n\t\tvar user = Meteor.users.findOne({\n\t\t\t_id: this.userId\n\t\t}, {\n\t\t\tfields: {\n\t\t\t\t'trueVault.id': true,\n\t\t\t\troles: true\n\t\t\t}\n\t\t});\n\t\tif (!Roles.userIsInRole(user, ['dentist', 'ma'])) {\n\t\t\tthrow new Meteor.Error(403);\n\t\t}\n\t\ttry {\n\t\t\tSessions.schemas.dentistNotes.clean(notes);\n\t\t\tcheck(notes, Sessions.schemas.dentistNotes);\n\t\t} catch (e) {\n\t\t\tthrow new Meteor.Error(400);\n\t\t}\n\n\t\tvar session = Sessions.collection.findOne({\n\t\t\t_id: notes.sessionId,\n\t\t\t'dentist.id': user._id,\n\t\t\tstate: 'voip',\n\t\t\t'voip.state': 'assigned'\n\t\t}, {\n\t\t\tfields: {\n\t\t\t\t_id: true,\n\t\t\t\t'dentist.id': true,\n\t\t\t\tstate: true,\n\t\t\t\t'voip.state': true\n\t\t\t}\n\t\t});\n\n\t\tif (!session) {\n\t\t\tthrow new Meteor.Error(404);\n\t\t}\n\n\t\tvar result;\n\t\ttry {\n\t\t\tresult = TrueVault.createDocument(notes, user.trueVault.id);\n\t\t} catch (e) {\n\t\t\tthrow new Meteor.Error(500);\n\t\t}\n\n\t\tsession['voip.state'] = session.voip.state;\n\t\tdelete session.voip;\n\t\tsession['dentist.id'] = session.dentist.id;\n\t\tdelete session.dentist;\n\t\tsession.dentistNotes = {\n\t\t\t$exists: false\n\t\t};\n\n\t\tvar updated = Sessions.collection.update(session, {\n\t\t\t$set: {\n\t\t\t\t'dentistNotes.trueVaultRef.docId': result.docId,\n\t\t\t\t'dentistNotes.trueVaultRef.vaultId': result.vaultId,\n\t\t\t\t'dentistNotes.trueVaultRef.transId': result.transId,\n\t\t\t\t'fax.state': 'ready'\n\t\t\t},\n\t\t\t$push: {\n\t\t\t\t'fax.history': { state: 'ready' }\n\t\t\t}\n\t\t});\n\n\t\tif (updated === 0) {\n\t\t\tthrow new Meteor.Error(404);\n\t\t}\n\n\t\treturn true;\n\t}\n});\n\nvar sessionsSort = new SimpleSchema({\n\tcreatedAt: {\n\t\ttype: Number,\n\t\tallowedValues: [1, -1],\n\t\toptional: true,\n\t\tautoValue: function() {\n\t\t\tvar location = this.field('location.name');\n\t\t\tvar dentist = this.field('dentist.username');\n\t\t\tif (!location && !dentist) {\n\t\t\t\treturn -1;\n\t\t\t}\n\t\t}\n\t},\n\t'location.name': {\n\t\ttype: Number,\n\t\tallowedValues: [1, -1],\n\t\toptional: true\n\t},\n\t'dentist.username': {\n\t\ttype: Number,\n\t\tallowedValues: [1, -1],\n\t\toptional: true\n\t}\n});\n\nvar sessionsFilter = new SimpleSchema({\n\t'location.id': {\n\t\ttype: String,\n\t\tregEx: SimpleSchema.RegEx.Id,\n\t\toptional: true\n\t},\n\t'dentist.id': {\n\t\ttype: String,\n\t\tregEx: SimpleSchema.RegEx.Id,\n\t\toptional: true\n\t},\n\tstart: {\n\t\ttype: Date,\n\t\toptional: true\n\t},\n\tend: {\n\t\ttype: Date,\n\t\toptional: true\n\t}\n});\n\nvar sessionsStatisticsFilter = new SimpleSchema({\n\t'location.id': {\n\t\ttype: String,\n\t\tregEx: SimpleSchema.RegEx.Id,\n\t\toptional: true\n\t},\n\tstart: {\n\t\ttype: Date\n\t},\n\tend: {\n\t\ttype: Date\n\t}\n});\n\nMeteor.publish('sessions', function(filter, sort, limit) {\n\tvar self = this;\n\tif (!Roles.userIsInRole(self.userId, ['ma', 'ta'])) {\n\t\treturn [];\n\t}\n\ttry {\n\t\tsessionsFilter.clean(filter);\n\t\tsessionsSort.clean(sort);\n\t\tcheck(filter, sessionsFilter);\n\t\tcheck(sort, sessionsSort);\n\t\tcheck(limit, Match.Optional(Number));\n\t} catch (e) {\n\t\treturn [];\n\t}\n\tlimit = limit || 10;\n\tif (filter.start || filter.end) {\n\t\tfilter.createdAt = {};\n\t\tif (filter.start) filter.createdAt.$gte = filter.start;\n\t\tif (filter.end) filter.createdAt.$lte = filter.end;\n\t\tdelete filter.start;\n\t\tdelete filter.end;\n\t}\n\tif (filter.dentist && filter.dentist.id) {\n\t\tfilter['dentist.id'] = filter.dentist.id;\n\t\tdelete filter.dentist;\n\t}\n\tif (filter.location && filter.location.id) {\n\t\tfilter['location.id'] = filter.location.id;\n\t\tdelete filter.location;\n\t}\n\tsessionsCountHandle = Counts.publish(self, 'sessionsCount', Sessions.collection.find(filter, { fields: { _id: true } }), { noReady: true });\n\tvar handle = Sessions.collection.find(filter, {\n\t\tfields: {\n\t\t\tcreatedAt: true,\n\t\t\t'location.name': true,\n\t\t\t'dentist.username': true,\n\t\t\tstate: true,\n\t\t\t'complete.condition': true\n\t\t},\n\t\tsort: sort,\n\t\tlimit: limit\n\t}).observeChanges({\n\t\tadded: function(id, fields) {\n\t\t\tif (fields.complete && fields.complete.condition) {\n\t\t\t\tfields.state = fields.complete.condition;\n\t\t\t\tdelete fields.complete;\n\t\t\t} else fields.state = 'inprogress';\n\t\t\tself.added('sessions', id, fields);\n\t\t},\n\t\tchanged: function(id, fields) {\n\t\t\tif (fields.complete && fields.complete.condition) {\n\t\t\t\tfields.state = fields.complete.condition;\n\t\t\t\tdelete fields.complete;\n\t\t\t} else if (fields.state) {\n\t\t\t\tfields.state = 'inprogress';\n\t\t\t}\n\t\t\tself.changed('sessions', id, fields);\n\t\t},\n\t\tremoved: function(id) {\n\t\t\tself.removed('sessions', id);\n\t\t}\n\t});\n\n\tself.ready();\n\tself.onStop(function() {\n\t\tsessionsCountHandle.stop();\n\t\thandle.stop();\n\t});\n});\n\nMeteor.publish('sessions.statistics', function(filter) {\n\tvar self = this;\n\tif (!Roles.userIsInRole(self.userId, ['ma', 'ta'])) {\n\t\treturn [];\n\t}\n\tvar initializing = true;\n\ttry {\n\t\tsessionsStatisticsFilter.clean(filter);\n\t\tcheck(filter, sessionsStatisticsFilter);\n\t} catch (e) {\n\t\treturn [];\n\t}\n\tfilter.createdAt = {\n\t\t$gte: filter.start,\n\t\t$lte: filter.end\n\t};\n\tdelete filter.start;\n\tdelete filter.end;\n\tif (filter.location && filter.location.id) {\n\t\tfilter['location.id'] = filter.location.id;\n\t\tdelete filter.location;\n\t}\n\tvar map = {};\n\tvar locMap = {};\n\tvar handle = Sessions.collection.find(filter, { fields: {\n\t\t'location.id': true,\n\t\t'complete.condition': true\n\t}}).observeChanges({\n\t\tadded: function (id, fields) {\n\t\t\tvar lId = fields.location.id;\n\t\t\tvar cond;\n\t\t\tif (!map[lId]) map[lId] = { stats: { finished: 0, inactive: 0, timeout: 0, inprogress: 0 } };\n\t\t\tif (fields.complete && fields.complete.condition) {\n\t\t\t\tcond = fields.complete.condition;\n\t\t\t} else {\n\t\t\t\tcond = 'inprogress';\n\t\t\t}\n\t\t\tmap[lId][id] = cond;\n\t\t\tmap[lId].stats[cond]++;\n\t\t\tlocMap[id] = lId;\n\t\t\tif (!initializing)\n\t\t\t\tself.changed('locations', lId, { aggregate: map[lId].stats });\n\t\t},\n\t\tchanged: function (id, fields) {\n\t\t\tif (fields.complete && fields.complete.condition) {\n\t\t\t\tvar lId = locMap[id];\n\t\t\t\tvar cond = map[lId][id];\n\t\t\t\tmap[lId].stats[cond]--;\n\t\t\t\tcond = fields.complete.condition;\n\t\t\t\tmap[lId][id] = cond;\n\t\t\t\tmap[lId].stats[cond]++;\n\t\t\t\tif (!initializing)\n\t\t\t\t\tself.changed('locations', lId, { aggregate: map[lId].stats });\n\t\t\t}\n\t\t},\n\t\tremoved: function (id) {\n\t\t\tvar lId = locMap[id];\n\t\t\tvar cond = map[lId][id];\n\t\t\tmap[lId].stats[cond]--;\n\t\t\tself.changed('locations', lId, { aggregate: map[lId].stats });\n\t\t}\n\t});\n\n\t_.each(map, function(value, key, list) {\n\t\tself.changed('locations', key, { aggregate: value.stats });\n\t});\n\tinitializing = false;\n\tself.ready();\n\n\tself.onStop(function() {\n\t\t_.each(map, function(value, key, list) {\n\t\t\tself.changed('locations', key, { aggregate: undefined });\n\t\t});\n\t\thandle.stop();\n\t});\n});\n\nMeteor.publish('sessions.voip.count', function() {\n\tvar self = this;\n\tif (!Roles.userIsInRole(self.userId, ['dentist', 'ma'])) {\n\t\treturn [];\n\t}\n\tenQueueCountsHandle = Counts.publish(this, 'enPatientQueue', Sessions.collection.find({\n\t\tstate: 'voip',\n\t\t'voip.state': 'queued',\n\t\tlang: 'en'\n\t}, { fields: { _id: true } }), { noReady: true });\n\tesQueueCountsHandle = Counts.publish(this, 'esPatientQueue', Sessions.collection.find({\n\t\tstate: 'voip',\n\t\t'voip.state': 'queued',\n\t\tlang: 'es'\n\t}, { fields: { _id: true } }), { noReady: true });\n\t//queueCountsHandle = Counts.publish(this, 'patientQueue', Sessions.collection.find({ state: 'voip', 'voip.state': 'queued' }, { fields: { _id: true } }));\n\tthis.onStop(function() {\n\t\t//queueCountsHandle.stop();\n\t\tenQueueCountsHandle.stop();\n\t\tesQueueCountsHandle.stop();\n\t});\n\tthis.ready();\n});\n\nMeteor.publish('session', function(sessionId) {\n\tvar self = this;\n\tvar user = Meteor.users.findOne({_id: self.userId}, {\n\t\tfields: {\n\t\t\tusername: true,\n\t\t\t'trueVault.id': true,\n\t\t\troles: true\n\t\t}\n\t\t\t\n\t});\n\tif (!Roles.userIsInRole(user, ['ma', 'ta'])) {\n\t\treturn [];\n\t}\n\ttry {\n\t\tcheck (sessionId, validId);\n\t} catch (e) {\n\t\treturn [];\n\t}\n\n\tvar transform = function(doc, user) {\n\t\tif (Roles.userIsInRole(user, ['ta'])) {\n\t\t\t\n\t\t}\n\t\tvar formDocId, notesDocId, formVaultId, notesVaultId;\n\t\tif (doc.form && doc.form.trueVaultRef) {\n\t\t\tvar formDocId = doc.form.trueVaultRef.docId;\n\t\t\tvar formVaultId = doc.form.trueVaultRef.vaultId;\n\t\t}\n\t\tif (doc.dentistNotes && doc.dentistNotes.trueVaultRef) {\n\t\t\tvar notesDocId = doc.dentistNotes.trueVaultRef.docId;\n\t\t\tvar notesVaultId = doc.dentistNotes.trueVaultRef.vaultId;\n\t\t}\n\t\tif (Roles.userIsInRole(user, ['ta'])) {\n\t\t\tif (formDocId) {\n\t\t\t\tdoc.form.exists = true;\n\t\t\t\tdelete doc.form.trueVaultRef;\n\t\t\t}\n\t\t\tif (notesDocId) {\n\t\t\t\tdoc.dentistNotes.exists = true;\n\t\t\t\tdelete doc.dentistNotes.trueVaultRef;\n\t\t\t}\n\t\t} else {\n\t\t\ttry {\n\t\t\t\tvar result, update;\n\t\t\t\tif (formDocId && notesDocId && formVaultId === notesVaultId) {\n\t\t\t\t\tresult = TrueVault.readTwoDocuments(formVaultId, formDocId, notesDocId, user.trueVault.id);\n\t\t\t\t\tdelete result.docOne.sessionId;\n\t\t\t\t\tdelete result.docTwo.sessionId;\n\t\t\t\t\tresult.docOne.at = doc.form.at;\n\t\t\t\t\tdoc.form = result.docOne;\n\t\t\t\t\tresult.docTwo.at = doc.dentistNotes.at;\n\t\t\t\t\tdoc.dentistNotes = result.docTwo;\n\t\t\t\t\tupdate = {\n\t\t\t\t\t\t$push: {\n\t\t\t\t\t\t\t'form.trueVaultRef.accessLog': {\n\t\t\t\t\t\t\t\tuserId: self.userId,\n\t\t\t\t\t\t\t\ttransId: result.docOne.transaction_id\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t'dentistNotes.trueVaultRef.accessLog': {\n\t\t\t\t\t\t\t\tuserId: self.userId,\n\t\t\t\t\t\t\t\ttransId: result.docTwo.transaction_id\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\t\t\t\t} else if (formDocId && notesDocId && formVaultId !== notesVaultId) {\n\t\t\t\t\treturn null;\n\t\t\t\t} else if (formDocId) {\n\t\t\t\t\tresult = TrueVault.readDocument(formVaultId, formDocId, user.trueVault.id);\n\t\t\t\t\tdelete result.sessionId;\n\t\t\t\t\tresult.at = doc.form.at;\n\t\t\t\t\tdoc.form = result;\n\t\t\t\t\tupdate = {\n\t\t\t\t\t\t$push: {\n\t\t\t\t\t\t\t'form.trueVaultRef.accessLog': {\n\t\t\t\t\t\t\t\tuserId: self.userId\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\t\t\t\t} else if (notesDocId) {\n\t\t\t\t\tresult = TrueVault.readDocument(notesVaultId, notesDocId, user.trueVault.id);\n\t\t\t\t\tdelete result.sessionId;\n\t\t\t\t\tresult.at = doc.dentistNotes.at;\n\t\t\t\t\tdoc.dentistNotes = result;\n\t\t\t\t\tupdate = {\n\t\t\t\t\t\t$push: {\n\t\t\t\t\t\t\t'dentistNotes.trueVaultRef.accessLog': {\n\t\t\t\t\t\t\t\tuserId: self.userId\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t\tSessions.collections.update({_id: sessionId}, update);\n\t\t\t} catch (e) {\n\t\t\t\t// Something what wrong...\n\t\t\t}\n\t\t}\n\t\treturn doc;\n\t};\n\n\tvar handle = Sessions.collection.find({_id: sessionId}, {\n\t\tfields: {\n\t\t\t'location.kioskHandle': false,\n\t\t\t'form.trueVaultRef.accessLog': false,\n\t\t\t'dentistNotes.trueVaultRef.accessLog': false,\n\t\t\t'modifiedAt': false\n\t\t}\n\t}).observeChanges({\n\t\tadded: function (id, fields) {\n\t\t\tself.added('sessions', id, transform(fields, user));\n\t\t},\n\t\tchanged: function (id, fields) {\n\t\t\tself.changed('sessions', id, transform(fields, user));\n\t\t},\n\t\tremoved: function (id) {\n\t\t\tself.remove('sessions', id);\n\t\t}\n\t});\n\tself.ready();\n\tself.onStop(function () {\n\t\thandle.stop();\n\t});\n});\n\nMeteor.publish('session.voip', function(sessionId) {\n\tcheck(sessionId, String);\n\tvar self = this;\n\n\tvar user = Meteor.users.findOne({_id: self.userId}, {\n\t\tfields: {\n\t\t\t'trueVault.id': true,\n\t\t\troles: true\n\t\t}\n\t});\n\tif (!Roles.userIsInRole(user, ['dentist', 'ma'])) {\n\t\treturn [];\n\t}\n\ttry {\n\t\tcheck(sessionId, validId);\n\t} catch (e) {\n\t\treturn [];\n\t}\n\n\tvar transform = function(doc, user) {\n\t\tvar result;\n\t\ttry {\n\t\t\tresult = TrueVault.readDocument(doc.form.trueVaultRef.vaultId, doc.form.trueVaultRef.docId, user.trueVault.id);\n\t\t\tdelete result.sessionId;\n\t\t\tresult.at = doc.form.at;\n\t\t\tdoc.form = result;\n\n\t\t\t// At the time of this writing (pi day) TrueVault doesn't return a transaction_id if you read a single document\n\t\t\tSessions.update({\n\t\t\t\t_id: doc._id\n\t\t\t}, {\n\t\t\t\t$push: {\n\t\t\t\t\t'form.trueVaultRef.accessLog': {\n\t\t\t\t\t\tuserId: user._id\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t} catch (e) {\n\t\t\t\n\t\t}\n\t\treturn doc;\n\t};\n\n\tvar handle = Sessions.collection.find({\n\t\t_id: sessionId,\n\t\t'dentist.id': self.userId,\n\t\tstate: 'voip'\n\t}, {\n\t\tfields: {\n\t\t\tlang: true,\n\t\t\t'location.kioskHandle': true,\n\t\t\t'form.trueVaultRef.docId': true,\n\t\t\t'form.trueVaultRef.vaultId': true\n\t\t}\n\t}).observeChanges({\n\t\tadded: function (id, fields) {\n\t\t\tself.added('sessions', id, transform(fields, user));\n\t\t},\n\t\tchanged: function (id, fields) {\n\t\t\tself.changed('sessions', id, transform(fields, user));\n\t\t},\n\t\tremoved: function (id) {\n\t\t\tself.removed('sessions', id);\n\t\t}\n\t});\n\tself.ready();\n\n\tself.onStop(function () {\n\t\thandle.stop();\n\t});\n});\n\nSyncedCron.add({\n\tname: 'Timeout sessions',\n\tschedule: function(parser) {\n\t\treturn parser.text('every 2 hour');\n\t},\n\tjob: function() {\n\t\tvar date = new Date;\n\t\tdate.setHours(date.getHours() - 6);\n\t\tSessions.collection.update({\n\t\t\tcreatedAt: { $lt: date },\n\t\t\tstate: { $ne: 'complete' }\n\t\t}, {\n\t\t\t$set: {\n\t\t\t\tstate: 'complete',\n\t\t\t\t'complete.condition': 'timeout'\n\t\t\t}\n\t\t}, {\n\t\t\tmulti: true\n\t\t});\n\t}\n});\n\nSyncedCron.add({\n\tname: 'Get SFax Results',\n\tschedule: function(parser) {\n\t\treturn parser.text('every 1 hour');\n\t},\n\tjob: function() {\n\t\tvar items = SFax.receiveOutboundFax();\n\t\t_.each(items, function (item) {\n\t\t\tif (item.TrackingCode) {\n\t\t\t\tvar state = (item.IsSuccess && item.FaxSuccess === '1') ? 'delivered' : 'failed';\n\t\t\t\tSessions.collection.update({\n\t\t\t\t\t_id: item.TrackingCode\n\t\t\t\t}, {\n\t\t\t\t\t$set: {\n\t\t\t\t\t\t'fax.state': state\n\t\t\t\t\t},\n\t\t\t\t\t$push: {\n\t\t\t\t\t\t'fax.history': {\n\t\t\t\t\t\t\tstate: state,\n\t\t\t\t\t\t\tresultCode: item.ResultCode,\n\t\t\t\t\t\t\terrorCode: item.ErrorCode,\n\t\t\t\t\t\t\tresultMessage: item.ResultMessage,\n\t\t\t\t\t\t\tfaxId: item.FaxId,\n\t\t\t\t\t\t\tpages: item.Pages,\n\t\t\t\t\t\t\tattempts: item.Attempts,\n\t\t\t\t\t\t\toutboundFaxId: item.OutboundFaxId\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t}\n});\n\nMeteor.startup(function () {\n\tvar failFax = function(id, reason) {\n\t\tSessions.collection.update({_id: id}, {\n\t\t\t$set: {\n\t\t\t\t'fax.state': 'failed'\n\t\t\t},\n\t\t\t$push: {\n\t\t\t\t'fax.history': {\n\t\t\t\t\t'state': 'failed',\n\t\t\t\t\t'reason': reason\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t};\n\n\t// Quick and dirty\n\tvar trans = {\n\t\ten: {\n\t\t\tform: {\n\t\t\t\theader: 'Dentist is In Session Report',\n\t\t\t\tpatientInfo: {\n\t\t\t\t\theader: 'Patient Information',\n\t\t\t\t\tname: 'Name: ',\n\t\t\t\t\taddress: 'Address: ',\n\t\t\t\t\temail: 'E-mail: ',\n\t\t\t\t\tphone: 'Phone Number: ',\n\t\t\t\t\tdob: 'Date of Birth: ',\n\t\t\t\t\tsex: 'Sex: ',\n\t\t\t\t\tpayment: 'Payment Method: ',\n\t\t\t\t\tM: 'Male',\n\t\t\t\t\tF: 'Female',\n\t\t\t\t\tInsurance: 'Insurance',\n\t\t\t\t\tMedicaid: 'Medicaid',\n\t\t\t\t\tSelf: 'Self Pay'\n\t\t\t\t},\n\t\t\t\tmedicalInfo: {\n\t\t\t\t\theader: 'Patient Medical Information',\n\t\t\t\t\tconditions: 'Medical Conditions: ',\n\t\t\t\t\tmedicalConditionsHivAids: 'HIV/AIDS',\n\t\t\t\t\tmedicalConditionsPregnant: 'Pregnant/Trying to get Pregnant',\n\t\t\t\t\tmedicalConditionsContraceptives: 'Taking Contraceptives',\n\t\t\t\t\tmedicalConditionsCancer: 'Cancer',\n\t\t\t\t\tmedicalConditionsDiabetes: 'Diabetes',\n\t\t\t\t\tmedicalConditionsHeart: 'Heart Condition',\n\t\t\t\t\tmedicalConditionsBlood: 'Blood Pressure Issues',\n\t\t\t\t\tmedicalConditionsKidneyLiver: 'Kidney or Liver Issues',\n\t\t\t\t\tmedicalConditionsStomach: 'Stomach Problems',\n\t\t\t\t\tmedicalConditionsBleeding: 'Bleeding Problems',\n\t\t\t\t\tmedicalConditionsPsychiatric: 'Psychiatric Care',\n\t\t\t\t\tmedicalConditionsRadiation: 'Radiation Treatment to the Head and Neck',\n\t\t\t\t\tmedications: 'Current Medications: ',\n\t\t\t\t\tallergies: 'Allergies: ',\n\t\t\t\t\tmedicalAllergiesAspirin: 'Aspirin',\n\t\t\t\t\tmedicalAllergiesCodeine: 'Codeine',\n\t\t\t\t\tmedicalAllergiesPenicillin: 'Penicillin',\n\t\t\t\t\tmedicalAllergiesSulfa: 'Sulfa Drugs',\n\t\t\t\t\tnone: 'None'\n\t\t\t\t},\n\t\t\t\tdentalComplaint: {\n\t\t\t\t\theader: 'Patient Dental Complaint',\n\t\t\t\t\tpain: 'Area of Pain: ',\n\t\t\t\t\tduration: 'Duration of Pain: ',\n\t\t\t\t\tswelling: 'Sweeling Present: ',\n\t\t\t\t\tY: 'Yes',\n\t\t\t\t\tN: 'No',\n\t\t\t\t\tseverity: 'Severity of Pain (1-10): '\n\t\t\t\t},\n\t\t\t\tdentistNotes: {\n\t\t\t\t\theader: 'Dentist Notes',\n\t\t\t\t\timpressions: 'Clinical Impressions: ',\n\t\t\t\t\trecommendations: 'Recommendations: ',\n\t\t\t\t\tprescriptions: 'Recommended Prescriptions: '\n\t\t\t\t}\n\t\t\t},\n\t\t\tprivacy: {\n\t\t\t\ttitle: 'Notice of Privacy Practices',\n\t\t\t\tdescription: 'This notice describes how Medical/Protected Health Information about you may be used and Disclosed and how you can get access to this Information. Please review it carefully.',\n\t\t\t\tsummary: 'Summary:',\n\t\t\t\tp1: 'By law, we are required to provide you with our Notice of Privacy Practices. (NPP)',\n\t\t\t\tp2: 'This notice describes how you medical information may be used and disclosed by us.',\n\t\t\t\tp3: 'It also tells you how you can obtain access to this information.',\n\t\t\t\tp4: 'As a patient, you have the following rights:',\n\t\t\t\titem1: 'The right to inspect and copy your information;',\n\t\t\t\titem2: 'The right to request corrections to your information;',\n\t\t\t\titem3: 'The right to request that your information be restricted;',\n\t\t\t\titem4: 'The right to request confidential communications;',\n\t\t\t\titem5: 'The right to report of disclosures of your information, and',\n\t\t\t\titem6: 'The right to paper copy of this notice.',\n\t\t\t\tp5: 'We want to assure you that your medical/protected health information is secure with us. This Notice contains information about how we will insure that your information remains private.',\n\t\t\t\tp6: 'If you have any questions about this notice, the name and phone number of our contact person is listed on this page.',\n\t\t\t\teffective: 'Effective date of this notice: June 1, 2015',\n\t\t\t\tcontact: 'Contact person: Michael Sigler',\n\t\t\t\tphone: 'Phone number: 816-550-2615',\n\t\t\t\tacknowledgement: 'Acknowledgment of Notice of Privacy practices:',\n\t\t\t\tp7: 'By checking the box, I hereby acknowledge that I have received a copy of the Notice of Privacy Practices. I understand that if I have questions or complaints about my privacy rights I can Contact the person listed above. I further understand that The Dentist Is IN will offer the updates to this Notice of Privacy Practices should it be amended, modified or changed in any way.'\n\t\t\t},\n\t\t\tconsent: {\n\t\t\t\ttitle: 'Informed Consent for Telemedicine Consultation Services',\n\t\t\t\th1: 'Introduction',\n\t\t\t\tp1: 'Telemedicine involves the use of electronic communications to enable health care providers at different locations to share individual patient medical information for the purpose of improving patient care. Providers may include primary care practitioners, specialists, and/or subspecialists. The information may be used for diagnosis, therapy, follow-up and/or education, and may include any of the following:',\n\t\t\t\ti11: 'Patient medical records',\n\t\t\t\ti12: 'Medical images',\n\t\t\t\ti13: 'Live two-way audio and video',\n\t\t\t\ti14: 'Output data from medical devices and sound and video files',\n\t\t\t\tp2: 'Electronic systems used will incorporate network and software security protocols to protect the confidentiality of patient identification and imaging data and will include measures to safeguard the data and to ensure its integrity against intentional or unintentional corruption.',\n\t\t\t\th2: 'Expected Benefits:',\n\t\t\t\ti21: 'Improved access to medical care by enabling a patient to remain at a remote site while the dentist consults with healthcare practitioners at distant/other sites.',\n\t\t\t\ti22: 'More efficient medical evaluation and management.',\n\t\t\t\ti23: 'Obtaining expertise of a distant specialist.',\n\t\t\t\th3: 'Possible Risks:',\n\t\t\t\ti31: 'In rare cases, information transmitted may not be sufficient (e.g. poor resolution of images) to allow for appropriate medical decision making by the nurse and consultant(s);',\n\t\t\t\ti32: 'Delays in medical evaluation and treatment could occur due to deficiencies or failures of the equipment;',\n\t\t\t\ti33: 'In very rare instances, security protocols could fail, causing a breach of privacy of personal medical information;',\n\t\t\t\ti34: 'In rare cases, a lack of access to complete medical records may result in adverse drug interactions or allergic reactions or other judgment errors;',\n\t\t\t\th4: 'By signing this form, I understand the following:',\n\t\t\t\ti41: 'I understand that the laws that protect privacy and the confidentiality of medical information also apply to telemedicine, and that no information obtained in the use of telemedicine which identifies me will be disclosed to researchers or other entities without my consent.',\n\t\t\t\ti42: 'I understand that I have the right to withhold or withdraw my consent to the use of telemedicine in the course of my care at any time, without affecting my right to future care or treatment.',\n\t\t\t\ti43: 'I understand that I have the right to inspect all information obtained and recorded in the course of a telemedicine interaction, and may receive copies of this information for a reasonable fee.',\n\t\t\t\ti44: 'I understand that a variety of alternative methods of medical care may be available to me, and that I may choose one or more of these at any time. My nurse has explained the alternatives to my satisfaction.',\n\t\t\t\ti45: 'I understand that telemedicine may involve electronic communication of my personal medical information to other medical practitioners who may be located in other areas, including out of state.',\n\t\t\t\ti46: 'I understand that it is my duty to inform my doctor of electronic interactions regarding my care that I may have with other healthcare providers.',\n\t\t\t\ti47: 'I understand that I may expect the anticipated benefits from the use of telemedicine in my care, but that no results can be guaranteed or assured.',\n\t\t\t\th5: 'Patient Consent To The Use of Telemedicine',\n\t\t\t\tp3: 'I have read and understand the information provided above regarding telemedicine, have discussed it with my nurse or such assistants as may be designated, and all of my questions have been answered to my satisfaction. I hereby give my informed consent for the use of telemedicine in my medical care.',\n\t\t\t\tp4: 'I hereby authorize The Dentist Is IN (consultant) to use telemedicine in the course of my dental consultation.'\n\t\t\t}\n\t\t},\n\t\tes: {\n\t\t\tform: {\n\t\t\t\theader: 'Dentista es en informe del período de sesiones',\n\t\t\t\tpatientInfo: {\n\t\t\t\t\theader: 'Información para el paciente',\n\t\t\t\t\tname: 'Nombre: ',\n\t\t\t\t\taddress: 'Dirección: ',\n\t\t\t\t\temail: 'Correo electrónico: ',\n\t\t\t\t\tphone: 'Número de teléfono: ',\n\t\t\t\t\tdob: 'Fecha de nacimiento: ',\n\t\t\t\t\tsex: 'Género: ',\n\t\t\t\t\tpayment: 'Método de pago: ',\n\t\t\t\t\tM: 'Hombre',\n\t\t\t\t\tF: 'Mujer',\n\t\t\t\t\tInsurance: 'Seguro dental',\n\t\t\t\t\tMedicaid: 'Medicaid',\n\t\t\t\t\tSelf: 'Pago del uno mismo'\n\t\t\t\t},\n\t\t\t\tmedicalInfo: {\n\t\t\t\t\theader: 'Información médica del paciente',\n\t\t\t\t\tconditions: 'Condiciones médicas: ',\n\t\t\t\t\tmedicalConditionsHivAids: 'SIDA/HIV Positivo',\n\t\t\t\t\tmedicalConditionsPregnant: 'Embarazada/tratando de quedar embarazada',\n\t\t\t\t\tmedicalConditionsContraceptives: 'Toma anticonceptivos orales',\n\t\t\t\t\tmedicalConditionsCancer: 'Cancer',\n\t\t\t\t\tmedicalConditionsDiabetes: 'Diabetes',\n\t\t\t\t\tmedicalConditionsHeart: 'Problemsa/Enfermedad del corazon',\n\t\t\t\t\tmedicalConditionsBlood: 'Presion arterial alta',\n\t\t\t\t\tmedicalConditionsKidneyLiver: 'Problemas de los ninones/higado',\n\t\t\t\t\tmedicalConditionsStomach: 'Enfermedad estomacal/intestinal',\n\t\t\t\t\tmedicalConditionsBleeding: 'Enermedad Arterial',\n\t\t\t\t\tmedicalConditionsPsychiatric: 'Atencion Psiquiatrica',\n\t\t\t\t\tmedicalConditionsRadiation: 'Tratamiento con radicion de cabeza',\n\t\t\t\t\tmedications: 'Tomando Medicamentos: ',\n\t\t\t\t\tallergies: 'Alergicos: ',\n\t\t\t\t\tmedicalAllergiesAspirin: 'Aspirina',\n\t\t\t\t\tmedicalAllergiesCodeine: 'Codenia',\n\t\t\t\t\tmedicalAllergiesPenicillin: 'Penicilina',\n\t\t\t\t\tmedicalAllergiesSulfa: 'Sulfamida',\n\t\t\t\t\tnone: 'Nada'\n\t\t\t\t},\n\t\t\t\tdentalComplaint: {\n\t\t\t\t\theader: 'Queja paciente Dental',\n\t\t\t\t\tpain: 'Área de dolor: ',\n\t\t\t\t\tduration: 'Duración del dolor: ',\n\t\t\t\t\tswelling: 'Presente hinchazón: ',\n\t\t\t\t\tY: 'Sí',\n\t\t\t\t\tN: 'No',\n\t\t\t\t\tseverity: 'Intensidad del dolor (1-10): '\n\t\t\t\t},\n\t\t\t\tdentistNotes: {\n\t\t\t\t\theader: 'Dentista notas',\n\t\t\t\t\timpressions: 'Impresiones clínicas: ',\n\t\t\t\t\trecommendations: 'Recomendaciones: ',\n\t\t\t\t\tprescriptions: 'Recetas recomendadas: '\n\t\t\t\t}\n\t\t\t},\n\t\t\tprivacy: {\n\t\t\t\ttitle: 'viso de Prácticas Privadas',\n\t\t\t\tdescription: 'Este Aviso Describe de Qué Modo Su Informatición Médica/de Salud Protegida Puede Ser untilizada Y Divulgada Y Cómo Puede Acceder A Dicha Informatición Revíselo Atentamente',\n\t\t\t\tsummary: 'Resumen:',\n\t\t\t\tp1: 'La ley nos exige suministrar a los pacentes el Avíso de Normas de Confidencialidad de',\n\t\t\t\tp2: 'Nuestro estalecimiento, qe describe cómo puede utilizarse y divulgarse su información',\n\t\t\t\tp3: 'Médica y establece las fromas en que el paciente pude accede a esta información.',\n\t\t\t\tp4: 'El paciente goza de los siguientes derechos:',\n\t\t\t\titem1: 'Derecho á accede a la información y realizer copias.',\n\t\t\t\titem2: 'Derecho á solicitor correcciones',\n\t\t\t\titem3: 'Derecho a solicitor restriciones.',\n\t\t\t\titem4: 'Derecho a solicitor confidenicaidad en las communications.',\n\t\t\t\titem5: 'Derecho a solicitor un detaile de la información divulgada , y',\n\t\t\t\titem6: 'Derecho a recibír una copia impressa de ester aviso.',\n\t\t\t\tp5: 'Queremos asegurar que su información de salud médica/protegido es segura con nosotros. Este aviso contiene información acerca de cómo nos asegurará que su información se mantenga privada.',\n\t\t\t\tp6: 'Si usted tiene alguna pregunta acerca de este aviso, el nombre y número de teléfono de nuestra persona de contacto aparece en esta página.',\n\t\t\t\teffective: 'Fecha de vigencia de este aviso: de 01 de junio de 2015',\n\t\t\t\tcontact: 'Persona de contacto: Leah Sigler',\n\t\t\t\tphone: 'Número de teléfono: 8169312191',\n\t\t\t\tacknowledgement: 'Reconocimiento del aviso de privacidad',\n\t\t\t\tp7: 'Por la presente reconozco que he recibido una copia de la Aviso de prácticas de privacidad. Yo entiendo que si tengo preguntas o quejas acerca de mi derechos de privacidad que puedo contactar a la persona indicada anteriormente. Además, entiendo que esta práctica ofrecerá las actualizaciones a este aviso de prácticas de privacidad si ser modificado, modificado o cambiado en de cualquier manera.'\n\t\t\t},\n\t\t\tconsent: {\n\t\t\t\ttitle: 'Autorización para recibir Servicios o Consulta de Telemedicine',\n\t\t\t\th1: 'Introducción',\n\t\t\t\tp1: 'Telemedicine involucra el uso de comunicación electrónica para acercar a los proveedores del cuidado de la salud ubicados en diferentes lugares, para compartir información médica de un paciente con el objetivo de mejorar su atención. Los proveedores pueden incluir médicos generales, especialistas o subespecialistas. La información podrá ser usada para diagnóstico, terapia, seguimiento y/o educación, y podrá incluir cualquiera de los siguientes conceptos:',\n\t\t\t\ti11: 'Historia clínica del paciente',\n\t\t\t\ti12: 'Imágenes médicas',\n\t\t\t\ti13: 'Audio y video en vivo',\n\t\t\t\ti14: 'Información producida por dispositivos médicos y archivos de audio y video',\n\t\t\t\tp2: 'Los sistemas electrónicos utilizados contendrán protocolos de seguridad para proteger la confidencialidad del paciente y sus imágenes, así como incluir medidas para salvaguardar la información y cuidar su integridad en contra de cualquier daño, con o sin intención.',\n\t\t\t\th2: 'Beneficios:',\n\t\t\t\ti21: 'Mejorar el acceso a la asistencia médica, permitiéndole al paciente dirigirse a un sitio remoto mientras el dentista consulta con otros médicos que se encuentran en distintos lugares.',\n\t\t\t\ti22: 'Evaluación y manejo médico eficiente',\n\t\t\t\ti23: 'Obtener asesoría de especialistas a distancia',\n\t\t\t\th3: 'Riesgos:',\n\t\t\t\ti31: 'En contadas ocasiones, la información transmitida puede ser insuficiente (e.g. mala calidad de las imágenes) y derivar en una mala decisión de la enfermera o el médico;',\n\t\t\t\ti32: 'Podría ocurrir algún retraso en la evaluación y tratamiento médico debido a fallas o deficiencias del equipo;',\n\t\t\t\ti33: 'Rara vez pueden fallar los protocolos de seguridad, causando una violación a la información privada de los pacientes;',\n\t\t\t\ti34: 'En algunas ocasiones, por falta de acceso a la historia clínica completa, podría haber errores en la prescripción de fármacos y causar reacciones alérgicas o algún otro error;',\n\t\t\t\th4: 'Al firmar esta forma entiendo lo siguiente:',\n\t\t\t\ti41: 'Entiendo que las leyes que protegen la privacidad y confidencialidad de la información médica también aplican para Telemedicine y que ninguna información de Telemedicine que me identifique podrá ser divulgada a los investigadores u otras agencias sin mi consentimiento.',\n\t\t\t\ti42: 'Entiendo que tengo derecho de otorgar o no mi consentimiento al uso de Telemedicine durante mi atención medica en cualquier momento, sin que eso afecte mi derecho a obtener atención o tratamiento en el futuro.',\n\t\t\t\ti43: 'Entiendo que tengo derecho a examinar toda la información obtenida y grabada durante la interacción con Telemedicine y puedo obtener copias de esta a un costo razonable.',\n\t\t\t\ti44: 'Entiendo que hay una variedad de métodos accesibles para mí y que puedo escoger uno o varios en cualquier momento. La enfermera me ha explicado las opciones a mi entera satisfacción. ',\n\t\t\t\ti45: 'Entiendo que Telemedicine puede enviar mi información médica por medios electrónicos a otros profesionales que pueden localizarse en diferentes áreas, incluso fuera del estado.',\n\t\t\t\ti46: 'Entiendo que es mi obligación informar a mi doctor sobre interacciones electrónicas que haya tenido en el pasado con otros doctores, relacionadas con mi salud/cuidado.',\n\t\t\t\ti47: 'Entiendo que espero beneficios anticipados en mi salud por el uso de Telemedicine, pero ningún resultado puede garantizarse o asegurarse.',\n\t\t\t\th5: 'Consentimiento del Paciente para el uso de Telemedicine',\n\t\t\t\tp3: 'He leído y entendido la información arriba mencionada respecto a Telemedicine. La he revisado con la enfermera o los asistentes designados y todas mis preguntas han sido respondidas a mi entera satisfacción. Doy mi consentimiento a Telemedicine para mi cuidado médico.',\n\t\t\t\tp4: 'Doy mi autorización a The Dentist Is In (consultor) para utilizar Telemedicine durante mis consultas dentales.'\n\t\t\t}\n\t\t}\n\t};\n\n\tvar makeReport = function(fax, lang, form, notes) {\n\t\tvar table = trans[lang].form;\n\t\tfax.fontSize(20);\n\t\tfax.text(table.header, { align: 'center' });\n\t\tfax.fontSize(12);\n\t\tfax.text(moment().locale(lang).format('LLLL'), { align: 'center' });\n\t\tvar patientInfo = table.patientInfo;\n\t\tfax.text(patientInfo.header, { underline: true });\n\t\tvar name = form.patientNameFirst;\n\t\tif (form.patientNamePreferred) name += ' (' + form.patientNamePreferred + ')';\n\t\tif (form.patientNameMiddle) name += ' ' + form.patientNameMiddle;\n\t\tname += ' ' + form.patientNameLast;\n\t\tfax.text(patientInfo.name + name);\n\t\tfax.text(patientInfo.address);\n\t\tfax.text(form.patientAddressOne, { indent: 30 });\n\t\tif (form.patientAddressTwo) fax.text(form.patientAddressTwo, { indent: 30 });\n\t\tfax.text(form.patientAddressCity + ', ' + form.patientAddressState + ' ' + form.patientAddressZip, { indent: 30 });\n\t\tif (form.patientContactEmail) fax.text(patientInfo.email + form.patientContactEmail);\n\t\tif (form.patientContactPhone) fax.text(patientInfo.phone + form.patientContactPhone);\n\t\t//fax.text(patientInfo.dob + moment(form.patientDobDob).locale(lang).format('LL'));\n\t\tfax.text(patientInfo.dob + form.patientDobDob);\n\t\tfax.text(patientInfo.sex + patientInfo[form.patientSexSex]);\n\t\tfax.text(patientInfo.payment + patientInfo[form.patientInsuranceInsurance]);\n\t\tfax.moveDown();\n\n\t\tvar medicalInfo = table.medicalInfo;\n\t\tfax.text(medicalInfo.header, { underline: true });\n\t\tvar re = /^medicalCondition/;\n\t\tvar list = _.reduce(form, function(memo, val, key) {\n\t\t\tif (re.test(key) && val) {\n\t\t\t\tif (memo === '') return medicalInfo[key];\n\t\t\t\telse return memo + ', ' + medicalInfo[key];\n\t\t\t} else return memo;\n\t\t}, '');\n\t\tif (list === '') list = medicalInfo.none;\n\t\tfax.text(medicalInfo.conditions + list);\n\t\tvar medications = (!form.medicalMedications || form.medicalMedications === '') ? medicalInfo.none : form.medicalMedications;\n\t\tfax.text(medicalInfo.medications + medications);\n\t\tre = /^medicalAllergies/;\n\t\tlist = _.reduce(form, function (memo, val, key) {\n\t\t\tif (re.test(key) && key !== 'medicalAllergiesOther' && val) {\n\t\t\t\tif (memo === '') return medicalInfo[key];\n\t\t\t\telse return memo + ', ' + medicalInfo[key];\n\t\t\t} else return memo;\n\t\t}, '');\n\t\tif (form.medicalAllergiesOther) list += ', ' + form.medicalAllergiesOther;\n\t\tif (list === '') list = medicalInfo.none;\n\t\tfax.text(medicalInfo.allergies + list);\n\t\tfax.moveDown();\n\n\t\tvar dentalComplaint = table.dentalComplaint;\n\t\tfax.text(dentalComplaint.header, { underline: true });\n\t\tfax.text(dentalComplaint.pain + form.dentalPain);\n\t\tfax.text(dentalComplaint.duration + form.dentalDuration);\n\t\tfax.text(dentalComplaint.swelling + dentalComplaint[form.dentalSwelling]);\n\t\tfax.text(dentalComplaint.severity + form.dentalSeverity);\n\t\tfax.moveDown();\n\n\t\tvar dentistNotes = table.dentistNotes;\n\t\tfax.text(dentistNotes.header, { underline: true });\n\t\tfax.text(dentistNotes.impressions);\n\t\tfax.text(notes.clinicalImpression, { indent: 30 });\n\t\tfax.text(dentistNotes.recommendations);\n\t\tfax.text(notes.recommendation, { indent: 30 });\n\t\tfax.text(dentistNotes.prescriptions);\n\t\tfax.text(notes.recommendedPrescriptions, { indent: 30 });\n\t};\n\n\tvar makePrivacy = function(fax, lang) {\n\t\tvar table = trans[lang].privacy;\n\t\tfax.fontSize(20);\n\t\tfax.text(table.title, { align: 'center' });\n\t\tfax.fontSize(12);\n\t\tfax.text(table.description, { align: 'center' });\n\t\tfax.moveDown();\n\n\t\tfax.text(table.summary, { underline: true });\n\t\tfax.text(table.p1);\n\t\tfax.text(table.p2);\n\t\tfax.text(table.p3);\n\t\tfax.text(table.p4);\n\t\tfax.text('\\u2022 ' + table.item1, { indent: 30 });\n\t\tfax.text('\\u2022 ' + table.item2, { indent: 30 });\n\t\tfax.text('\\u2022 ' + table.item3, { indent: 30 });\n\t\tfax.text('\\u2022 ' + table.item4, { indent: 30 });\n\t\tfax.text('\\u2022 ' + table.item5, { indent: 30 });\n\t\tfax.text('\\u2022 ' + table.item6, { indent: 30 });\n\t\tfax.moveDown();\n\n\t\tfax.text(table.p5);\n\t\tfax.text(table.p6);\n\t\tfax.text(table.effective);\n\t\tfax.text(table.contact);\n\t\tfax.text(table.phone);\n\t\tfax.moveDown();\n\n\t\tfax.fontSize(20);\n\t\tfax.text(table.acknowledgement, { align: 'center' });\n\t\tfax.fontSize(12);\n\t\tfax.text(table.p7);\n\t};\n\n\tvar makeConsent = function(fax, lang) {\n\t\tvar table = trans[lang].consent;\n\t\tfax.fontSize(20);\n\t\tfax.text(table.title, { align: 'center' });\n\t\tfax.moveDown();\n\n\t\tfax.fontSize(12);\n\t\tfax.text(table.h1, { underline: true });\n\t\tfax.text(table.p1);\n\t\tfax.text('\\u2022 ' + table.i11, { indent: 30 });\n\t\tfax.text('\\u2022 ' + table.i12, { indent: 30 });\n\t\tfax.text('\\u2022 ' + table.i13, { indent: 30 });\n\t\tfax.text('\\u2022 ' + table.i14, { indent: 30 });\n\t\tfax.text(table.p2);\n\t\tfax.moveDown();\n\n\t\tfax.text(table.h2, { underline: true });\n\t\tfax.text('\\u2022 ' + table.i21, { indent: 30 });\n\t\tfax.text('\\u2022 ' + table.i22, { indent: 30 });\n\t\tfax.text('\\u2022 ' + table.i23, { indent: 30 });\n\t\tfax.moveDown();\n\n\t\tfax.text(table.h3, { underline: true });\n\t\tfax.text('\\u2022 ' + table.i31, { indent: 30 });\n\t\tfax.text('\\u2022 ' + table.i32, { indent: 30 });\n\t\tfax.text('\\u2022 ' + table.i33, { indent: 30 });\n\t\tfax.text('\\u2022 ' + table.i34, { indent: 30 });\n\t\tfax.moveDown();\n\n\t\tfax.text(table.h4, { underline: true });\n\t\tfax.text('1. ' + table.i41, { indent: 30 });\n\t\tfax.text('2. ' + table.i42, { indent: 30 });\n\t\tfax.text('3. ' + table.i43, { indent: 30 });\n\t\tfax.text('4. ' + table.i44, { indent: 30 });\n\t\tfax.text('5. ' + table.i45, { indent: 30 });\n\t\tfax.text('6. ' + table.i46, { indent: 30 });\n\t\tfax.text('7. ' + table.i47, { indent: 30 });\n\t\tfax.moveDown();\n\n\t\tfax.fontSize(20);\n\t\tfax.text(table.h5, { align: 'center' });\n\t\tfax.fontSize(12);\n\t\tfax.text(table.p3);\n\t\tfax.text(table.p4);\n\t};\n\n\tvar getFaxBuffer = function(formDoc, notesDoc, lang, callback) {\n\t\tvar buffer = new Buffer(0);\n\t\tvar fax = new PDFDocument();\n\n\t\tfax.on('readable', function() {\n\t\t\tbuffer = Buffer.concat([buffer, fax.read()]);\n\t\t});\n\n\t\tfax.on('error', function(err) {\n\t\t\tcallback(err, null);\n\t\t});\n\n\t\tfax.on('end', function() {\n\t\t\tcallback(null, buffer);\n\t\t});\n\n\t\tmakeReport(fax, 'en', formDoc, notesDoc);\n\t\tfax.addPage();\n\t\tmakePrivacy(fax, 'en');\n\t\tfax.addPage();\n\t\tmakeConsent(fax, 'en');\n\t\tfax.addPage();\n\t\tmakeReport(fax, lang, formDoc, notesDoc);\n\t\tfax.addPage();\n\t\tmakePrivacy(fax, lang);\n\t\tfax.addPage();\n\t\tmakeConsent(fax, lang);\n\t\tfax.end();\n/**\n\t\tfax.text('Dentist is In Session Reporrt', { align: 'center' });\n\t\tfax.text(new Date(), { align: 'center' });\n\t\tfax.text('Patient Information', { underline: true });\n\t\tvar name = formDoc.patientNameFirst;\n\t\tif (formDoc.patientNamePreferred) name += ' (' + formDoc.patientNamePreferred + ')';\n\t\tif (formDoc.patientNameMiddle) name += ' ' + formDoc.patientNameMiddle;\n\t\tname += ' ' + formDoc.patientNameLast;\n\t\tfax.text('Name: ' + name);\n\t\tfax.text('Address:');\n\t\tfax.text('         ' + formDoc.patientAddressOne);\n\t\tif (formDoc.patientAddressTwo) fax.text('         ' + formDoc.patientAddressTwo);\n\t\tfax.text('         ' + formDoc.patientAddressCity + ', ' + formDoc.patientAddressState + ' ' + formDoc.patientAddressZip);\n\t\tif (formDoc.patientContactEmail) fax.text('E-mail: ' + formDoc.patientContactEmail);\n\t\tif (formDoc.patientContactPhone) fax.text('Phone Number: ' + formDoc.patientContactPhone);\n\t\tfax.text('Date of Birth: ' + moment(formDoc.patientDobDob).format('MM-DD-YYYY'));\n\t\tvar sex = (formDoc.patientSexSex === 'F') ? 'Female' : 'Male';\n\t\tfax.text('Sex: ' + sex);\n\t\tvar insurance = (formDoc.patientInsuranceInsurance === 'Self') ? 'Self Pay' : formDoc.patientInsuranceInsurance;\n\t\tfax.text('Payment Method: ' + insurance);\n\t\tfax.moveDown();\n\t\tfax.text('Patient Medical Information', { underline: true });\n\t\tvar table = {\n\t\t\tmedicalConditionsHivAids: 'HIV/AIDS',\n\t\t\tmedicalConditionsPregnant: 'Pregnant/Trying to get Pregnant',\n\t\t\tmedicalConditionsContraceptives: 'Taking Contraceptives',\n\t\t\tmedicalConditionsCancer: 'Cancer',\n\t\t\tmedicalConditionsDiabetes: 'Diabetes',\n\t\t\tmedicalConditionsHeart: 'Heart Condition',\n\t\t\tmedicalConditionsBlood: 'Blood Pressure Issues',\n\t\t\tmedicalConditionsKidneyLiver: 'Kidney or Liver Issues',\n\t\t\tmedicalConditionsStomach: 'Stomach Problems',\n\t\t\tmedicalConditionsBleeding: 'Bleeding Problems',\n\t\t\tmedicalConditionsPsychiatric: 'Psychiatric Care',\n\t\t\tmedicalConditionsRadiation: 'Radiation Treatment to the Head and Neck',\n\t\t};\n\t\tvar re = /^medicalCondition/;\n\t\tvar list = _.reduce(formDoc, function(memo, val, key) {\n\t\t\tif (re.test(key) && val) {\n\t\t\t\tif (memo === '') return table[key];\n\t\t\t\telse return memo + ', ' + table[key];\n\t\t\t} else return memo;\n\t\t}, '');\n\t\tif (list === '') list = 'None';\n\t\tfax.text('Medical Conditions: ' + list);\n\t\tvar medications = (!formDoc.medicalMedications || formDoc.medicalMedications === '') ? 'None' : formDoc.medicalMedications;\n\t\tfax.text('Current Medications: ' + medications);\n\t\ttable = {\n\t\t\tmedicalAllergiesAspirin: 'Aspirin',\n\t\t\tmedicalAllergiesCodeine: 'Codeine',\n\t\t\tmedicalAllergiesPenicillin: 'Penicillin',\n\t\t\tmedicalAllergiesSulfa: 'Sulfa Drugs'\n\t\t};\n\t\tre = /^medicalAllergies/;\n\t\tlist = _.reduce(formDoc, function(memo, val, key) {\n\t\t\tif (re.test(key) && key !== 'medicalAllergiesOther' && val) {\n\t\t\t\tif (memo === '') return table[key];\n\t\t\t\telse return memo + ', ' + table[key];\n\t\t\t} else return memo;\n\t\t}, '');\n\t\tif (formDoc.medicalAllergiesOther) list += ', ' + formDoc.medicalAllergiesOther;\n\t\tif (list === '') list = 'None';\n\t\tfax.text('Allergies: ' + list);\n\t\tfax.moveDown();\n\t\tfax.text('Patient Dental Complaint', { underline: true });\n\t\tfax.text('Area of Pain: ' + formDoc.dentalPain);\n\t\tfax.text('Duration of Pain: ' + formDoc.dentalDuration);\n\t\tvar swelling = (formDoc.dentalSwelling === 'Y') ? 'Yes' : 'No';\n\t\tfax.text('Swelling Present: ' + swelling);\n\t\tfax.text('Severity of Pain (1-10): ' + formDoc.dentalSeverity);\n\t\tfax.moveDown();\n\t\tfax.text('Dentist Notes', { underline: true });\n\t\tfax.text('Clinical Impressions:');\n\t\tfax.text(notesDoc.clinicalImpression);\n\t\tfax.text('Recommendations:');\n\t\tfax.text(notesDoc.recommendation);\n\t\tfax.text('Recommended Prescriptions:');\n\t\tfax.text(notesDoc.recommendedPrescriptions);\n\t\tfax.end();\n**/\n\t};\n\tvar getFaxBufferSync = Meteor.wrapAsync(getFaxBuffer);\n\n\tvar handle = Sessions.collection.find({\n\t\t'fax.state': 'ready'\n\t}, {\n\t\t_id: true}\n\t).observeChanges({\n\t\tadded: function(id, session) {\n\t\t\tvar locked = Sessions.collection.findAndModify({\n\t\t\t\tquery: {\n\t\t\t\t\t _id: id\n\t\t\t\t},\n\t\t\t\tupdate: {\n\t\t\t\t\t$set: {\n\t\t\t\t\t\t'fax.state': 'locked'\n\t\t\t\t\t},\n\t\t\t\t\t$push: {\n\t\t\t\t\t\t'fax.history': { at: new Date, state: 'locked' }\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tfields: {\n\t\t\t\t\t'location.id': true,\n\t\t\t\t\tlang: true,\n\t\t\t\t\t'form.trueVaultRef.docId': true,\n\t\t\t\t\t'form.trueVaultRef.vaultId': true,\n\t\t\t\t\t'dentistNotes.trueVaultRef.docId': true,\n\t\t\t\t\t'dentistNotes.trueVaultRef.vaultId': true\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tif (!locked) return;\n\t\t\tif (!locked.form) {\n\t\t\t\tfailFax(id, 'Missing form');\n\t\t\t\treturn;\n\t\t\t} else if (!locked.form.trueVaultRef) {\n\t\t\t\tfailFax(id, 'Missing form reference');\n\t\t\t\treturn;\n\t\t\t} else {\n\t\t\t\tif (!locked.form.trueVaultRef.vaultId) {\n\t\t\t\t\tfailFax(id, 'Missing form vault reference');\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tif (!locked.form.trueVaultRef.docId) {\n\t\t\t\t\tfailFax(id, 'Missing form doc reference');\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (!locked.dentistNotes) {\n\t\t\t\tfailFax(id, 'Missing notes');\n\t\t\t\treturn;\n\t\t\t} else if (!locked.dentistNotes.trueVaultRef) {\n\t\t\t\tfailFax(id, 'Missing notes reference');\n\t\t\t\treturn;\n\t\t\t} else {\n\t\t\t\tif (!locked.dentistNotes.trueVaultRef.vaultId) {\n\t\t\t\t\tfailFax(id, 'Missing notes vault reference');\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tif (!locked.dentistNotes.trueVaultRef.docId) {\n\t\t\t\t\tfailFax(id, 'Missing notes doc reference');\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\t\t\tvar formId = locked.form.trueVaultRef.docId;\n\t\t\tvar notesId = locked.dentistNotes.trueVaultRef.docId;\n\n\t\t\tvar forms = TrueVault.readTwoDocuments(locked.form.trueVaultRef.vaultId, formId, notesId);\n\t\t\tSessions.collection.update({_id: id}, {\n\t\t\t\t$push: {\n\t\t\t\t\t'form.trueVaultRef.accessLog': {\n\t\t\t\t\t\tfax: true,\n\t\t\t\t\t\ttransId: forms.transId\n\t\t\t\t\t},\n\t\t\t\t\t'dentistNotes.trueVaultRef.accessLog': {\n\t\t\t\t\t\tfax: true,\n\t\t\t\t\t\ttransId: forms.transId\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tvar buf = getFaxBufferSync(forms.docOne, forms.docTwo, locked.lang);\n\n\t\t\tvar location = Locations.collection.findOne({ _id: locked.location.id}, { fields: { name: true, 'contact.fax': true } });\n\t\t\tvar sendFax = SFax.sendFax(id, location.name, location.contact.fax, buf);\n\t\t\tSessions.collection.update({\n\t\t\t\t_id: id,\n\t\t\t\t'fax.state': 'locked'\n\t\t\t}, {\n\t\t\t\t$set: {\n\t\t\t\t\t'fax.state': 'sent'\n\t\t\t\t},\n\t\t\t\t$push: {\n\t\t\t\t\t'fax.history': { state: 'sent', SendFaxQueueId: sendFax.SendFaxQueueId }\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t});\n});\n"]}